# Generative Ensemble Kalman Filter (Generative EnKF)

[![CI](https://github.com/yasahi-hpc/Generative-EnKF/actions/workflows/ci.yml/badge.svg)](https://github.com/yasahi-hpc/Generative-EnKF/actions)

<div style style=”line-height: 25%” align="center">
<h3> Generate pseudo ensembles with an observation guided diffusion model </h3>
<img src=docs/figs/diffuion_overview.png>
</div>

_Generative EnKF_ is designed to surrogate data assimilation (DA) for numerical simulations without ensemble runs. Forecasting a real world system is often achieved by combining a scientific model for the time evolution of the system and an estimate of the current state of the system. Basically, DA like Ensemble Kalman Filter (EnKF) blends the simulation states and observation data iteratively to give a reasonable estimate of the current state. Though widely used, EnKF has two critical issues: fragile to model biases (errors) and the ensemble simulation costs. Here, we propose a DA method using the pseudo ensembles generated by observation guided denoising diffusion probabilistic model (DDPM). Thanks to the variance in generated ensembles, our proposed method displays better performance than the well-established ensemble DA method (say, EnKF) when the simulation model is biased. For questions or comments, please find us in the [AUTHORS](AUTHORS) file.

# Usage

## Installation
This code relies on the following packages. As a deeplearing framework, we use [PyTorch](https://pytorch.org).
- Install Python libraries
[numpy](https://numpy.org), [PyTorch](https://pytorch.org), [xarray](http://xarray.pydata.org/en/stable/), and [netcdf4](https://github.com/Unidata/netcdf4-python)

- Clone this repo  
```git clone https://github.com/yasahi-hpc/Generative-EnKF.git```

## Preparation
Before running simulation with Generative EnKF, we need to train a diffusion model guided by observations. 
Firstly, one needs to construct a dataset and train the model for that.
See [deep learning model](docs/dl_model.md) for detail. 

## Simulation with Generative EnKF
For simulation, we rely on the [simulation codes](docs/simulation.md) and the pretrained diffusion model. 

## Citations
```bibtex
@INPROCEEDINGS{Asahi2023, 
      author={Asahi, Yuuichi and Hasegawa, Yuta and Onodera, Naoyuki and and Shimokawabe, Takashi and Shiba, Hayato and Idomura, Yasuhiro},
      booktitle={ICML 2023 Workshop SynS and ML}
      title={Generating observation guided ensembles for data assimilation with denoising diffusion probabilistic model},
      year={2023},
      volume={},
      number={},
      pages={},
      keywords = {Deep learning; Graphics-processing-unit-based computing; Data Assimilation; Lorenz96},
}
```
